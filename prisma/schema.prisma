generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String              @id @default(cuid())
  email                   String              @unique
  passwordHash            String?
  firstName               String
  lastName                String
  username                String?             @unique
  profileImage            String?
  bio                     String?
  membershipLevel         MembershipLevel     @default(FREE)
  isActive                Boolean             @default(true)
  emailVerified           Boolean             @default(false)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  lastLogin               DateTime?
  verificationCode        String?
  stripeCustomerId        String?             @unique
  verificationCodeExpires DateTime?
  country                 String?
  hasBeenPremium          Boolean             @default(false)
  comments                Comment[]
  posts                   CommunityPost[]
  courses                 Course[]            @relation("CourseInstructor")
  enrollments             Enrollment[]
  eventRegistrations      EventRegistration[]
  likes                   Like[]
  payments                Payment[]
  ratings                 Rating[]
  resourceAccessLogs      ResourceAccessLog[]
  sessions                Session[]
  subscriptions           Subscription[]
  securityLogs            SecurityLog[]
  promotionInteractions   PromotionInteraction[]
  userBehaviors           UserBehavior[]
  userPreferences         UserPreference?
  recommendations         Recommendation[]
  achievements            Achievement[]

  @@index([membershipLevel])
  @@index([email, membershipLevel])
  @@index([createdAt]) // ✅ Nuevo: Para consultas por fecha
  @@index([isActive, emailVerified]) // ✅ Nuevo: Para filtros de usuarios activos
  @@index([stripeCustomerId]) // ✅ Nuevo: Para consultas de Stripe
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt]) // ✅ Nuevo: Para limpiar sesiones expiradas
  @@map("sessions")
}

model Course {
  id               String       @id @default(cuid())
  title            String
  slug             String       @unique
  description      String?
  shortDescription String?
  imageUrl         String?
  price            Decimal      @default(0)
  isFree           Boolean      @default(true)
  requiresAuth     Boolean      @default(true)
  difficulty       Difficulty?
  durationHours    Int?
  lessonsCount     Int          @default(0)
  studentsCount    Int          @default(0)
  rating           Decimal      @default(0)
  status           CourseStatus @default(DRAFT)
  category         CourseCategory @default(HABILIDADES_IRREMPLAZABLES)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  instructorId     String?
  comments         Comment[]
  instructor       User?        @relation("CourseInstructor", fields: [instructorId], references: [id])
  enrollments      Enrollment[]
  lessons          Lesson[]
  payments         Payment[]
  ratings          Rating[]

  @@index([status, createdAt]) // ✅ Nuevo: Para listar cursos publicados
  @@index([instructorId]) // ✅ Nuevo: Para cursos por instructor
  @@index([slug]) // ✅ Nuevo: Para búsquedas por slug
  @@index([category]) // ✅ Nuevo: Para filtros por categoría
  @@map("courses")
}

model Comment {
  id        String         @id @default(cuid())
  content   String
  type      CommentType
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  userId    String
  courseId  String?
  parentId  String?
  postId    String?
  course    Course?        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  parent    Comment?       @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[]      @relation("CommentReplies")
  post      CommunityPost? @relation("PostComments", fields: [postId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes     Like[]

  @@index([courseId, createdAt]) // ✅ Nuevo: Para comentarios de cursos
  @@index([userId, createdAt]) // ✅ Nuevo: Para comentarios por usuario
  @@map("comments")
}

model CommunityPost {
  id        String    @id @default(cuid())
  title     String
  content   String
  category  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    String
  comments  Comment[] @relation("PostComments")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes     Like[]
  ratings   Rating[]

  @@index([userId, createdAt]) // ✅ Nuevo: Para posts por usuario
  @@index([category, createdAt]) // ✅ Nuevo: Para posts por categoría
  @@map("community_posts")
}

model Enrollment {
  id                 String           @id @default(cuid())
  enrolledAt         DateTime         @default(now())
  completedAt        DateTime?
  progressPercentage Decimal          @default(0)
  status             EnrollmentStatus @default(ACTIVE)
  userId             String
  courseId           String
  progress           CourseProgress?
  course             Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId, status]) // ✅ Nuevo: Para inscripciones activas del usuario
  @@index([courseId, status]) // ✅ Nuevo: Para estudiantes de un curso
  @@index([enrolledAt]) // ✅ Nuevo: Para estadísticas por fecha
  @@map("enrollments")
}

model CourseProgress {
  id                 String               @id @default(cuid())
  enrollmentId       String               @unique
  currentLesson      Int                  @default(0)
  completedLessons   Int[]                @default([])
  progressPercentage Decimal              @default(0)
  lastAccessed       DateTime             @default(now())
  startedAt          DateTime             @default(now())
  completedAt        DateTime?
  totalTimeSpent     Int                  @default(0)
  totalSessions      Int                  @default(0)
  averageSessionTime Int                  @default(0)
  longestSession     Int                  @default(0)
  status             CourseProgressStatus @default(IN_PROGRESS)
  courseSpecificData Json?
  enrollment         Enrollment           @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lessonProgress     LessonProgress[]

  @@index([enrollmentId]) // ✅ Nuevo: Para joins rápidos
  @@index([status, lastAccessed]) // ✅ Nuevo: Para progreso reciente
  @@map("course_progress")
}

model LessonProgress {
  id                 String         @id @default(cuid())
  courseProgressId   String
  lessonNumber       Int
  lessonTitle        String
  isCompleted        Boolean        @default(false)
  completedAt        DateTime?
  timeSpent          Int            @default(0)
  firstAccessed      DateTime       @default(now())
  lastAccessed       DateTime       @default(now())
  accessCount        Int            @default(0)
  completionAttempts Int            @default(0)
  userNotes          String?
  lessonSpecificData Json?
  courseProgress     CourseProgress @relation(fields: [courseProgressId], references: [id], onDelete: Cascade)

  @@unique([courseProgressId, lessonNumber])
  @@index([courseProgressId, lessonNumber]) // ✅ Nuevo: Para ordenamiento eficiente
  @@map("lesson_progress")
}

model Like {
  id        String         @id @default(cuid())
  createdAt DateTime       @default(now())
  userId    String
  commentId String?
  postId    String?
  comment   Comment?       @relation(fields: [commentId], references: [id], onDelete: Cascade)
  post      CommunityPost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId, postId])
  @@index([userId, createdAt]) // ✅ Nuevo: Para likes por usuario
  @@map("likes")
}

model Lesson {
  id        String   @id @default(cuid())
  title     String
  content   String?
  videoUrl  String?
  duration  Int?
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId, order]) // ✅ Nuevo: Para lecciones ordenadas
  @@map("lessons")
}

model Payment {
  id              String        @id @default(cuid())
  stripePaymentId String        @unique
  amount          Int
  currency        String        @default("usd")
  status          PaymentStatus
  paymentMethod   String?
  description     String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  userId          String
  courseId        String?
  subscriptionId  String?
  course          Course?       @relation(fields: [courseId], references: [id])
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id])
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt]) // ✅ Nuevo: Para pagos por usuario
  @@index([status, createdAt]) // ✅ Nuevo: Para pagos por estado
  @@index([courseId]) // ✅ Nuevo: Para pagos de cursos
  @@map("payments")
}

model Subscription {
  id                   String             @id @default(cuid())
  stripeSubscriptionId String             @unique
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  endedAt              DateTime?
  trialStart           DateTime?
  trialEnd             DateTime?
  metadata             Json?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  userId               String
  priceId              String
  payments             Payment[]
  price                Price              @relation(fields: [priceId], references: [id])
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status, currentPeriodEnd])
  @@index([status, currentPeriodEnd])
  @@index([userId, status]) // ✅ Nuevo: Para suscripciones activas del usuario
  @@map("subscriptions")
}

model Product {
  id              String   @id @default(cuid())
  stripeProductId String   @unique
  name            String
  description     String?
  active          Boolean  @default(true)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  prices          Price[]

  @@index([active]) // ✅ Nuevo: Para productos activos
  @@map("products")
}

model Price {
  id              String           @id @default(cuid())
  stripePriceId   String           @unique
  active          Boolean          @default(true)
  currency        String           @default("usd")
  type            PriceType
  unitAmount      Int?
  interval        BillingInterval?
  intervalCount   Int?
  trialPeriodDays Int?
  metadata        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  productId       String
  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  subscriptions   Subscription[]

  @@index([active, productId]) // ✅ Nuevo: Para precios activos por producto
  @@map("prices")
}

model Resource {
  id               String              @id @default(cuid())
  title            String
  slug             String              @unique
  description      String?
  shortDescription String?
  imageUrl         String?
  category         ResourceCategory
  type             ResourceType
  author           String?
  fileUrl          String?
  requiresAuth     Boolean            @default(true)
  isFree           Boolean            @default(false)
  rating           Decimal            @default(0)
  downloadsCount   Int                @default(0)
  status           ResourceStatus     @default(DRAFT)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  topics           ResourceTopic[]
  accessLogs       ResourceAccessLog[]

  @@index([category, status]) // ✅ Nuevo: Para recursos por categoría
  @@index([status, createdAt]) // ✅ Nuevo: Para recursos publicados
  @@map("resources")
}

model ResourceTopic {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int      @default(0)
  resourceId  String
  resource    Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([resourceId, title])
  @@map("resource_topics")
}

model ResourceAccessLog {
  id         String   @id @default(cuid())
  accessedAt DateTime @default(now())
  userId     String
  resourceId String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([userId, accessedAt]) // ✅ Nuevo: Para acceso por usuario
  @@index([resourceId, accessedAt]) // ✅ Nuevo: Para estadísticas de recurso
  @@map("resource_access_logs")
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  location    String?
  type        EventType
  maxCapacity Int?
  currentCapacity Int    @default(0)
  price       Decimal   @default(0)
  isFree      Boolean   @default(true)
  status      String    @default("UPCOMING")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  registrations EventRegistration[]

  @@index([startDate, status]) // ✅ Nuevo: Para eventos próximos
  @@index([type, status]) // ✅ Nuevo: Para eventos por tipo
  @@map("events")
}

model EventRegistration {
  id        String   @id @default(cuid())
  registeredAt DateTime @default(now())
  userId    String
  eventId   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([eventId, registeredAt]) // ✅ Nuevo: Para registros por evento
  @@index([userId, registeredAt]) // ✅ Nuevo: Para registros por usuario
  @@map("event_registrations")
}

model Rating {
  id        String      @id @default(cuid())
  rating    Int
  type      RatingType
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  userId    String
  courseId  String?
  postId    String?
  course    Course?     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  post      CommunityPost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([courseId, rating]) // ✅ Nuevo: Para ratings de cursos
  @@index([userId, type]) // ✅ Nuevo: Para ratings por usuario
  @@map("ratings")
}

model SecurityLog {
  id        String   @id @default(cuid())
  event     String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([event, createdAt]) // ✅ Nuevo: Para logs de seguridad
  @@index([userId, createdAt]) // ✅ Nuevo: Para logs por usuario
  @@map("security_logs")
}

enum CourseProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  PAUSED
  ABANDONED
}

enum MembershipLevel {
  FREE
  PREMIUM
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CourseCategory {
  HABILIDADES_IRREMPLAZABLES
  IA_PARA_EMPRENDER
  DESARROLLO_WEB
  MARKETING_DIGITAL
  PRODUCTIVIDAD
  FINANZAS_PERSONALES
  LIDERAZGO
  INNOVACION_TECNOLOGICA
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CommentType {
  COURSE
  POST
  RESOURCE
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  PAUSED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAST_DUE
  TRIALING
  UNPAID
}

enum PriceType {
  ONE_TIME
  RECURRING
}

enum BillingInterval {
  DAY
  WEEK
  MONTH
  YEAR
}

enum ResourceCategory {
  EBOOK
  VIDEO
  TEMPLATE
  TOOL
  GUIDE
  CASE_STUDY
  WHITEPAPER
  CHECKLIST
  WORKSHOP
  WEBINAR
}

enum ResourceType {
  PDF
  VIDEO
  AUDIO
  IMAGE
  DOCUMENT
  PRESENTATION
  SPREADSHEET
  ARCHIVE
  LINK
  OTHER
}

enum ResourceStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum EventType {
  WORKSHOP
  WEBINAR
  CONFERENCE
  MEETUP
  COURSE_LAUNCH
  Q_A
  NETWORKING
}

enum RatingType {
  COURSE
  POST
  RESOURCE
}

enum PromotionType {
  PREMIUM_SUBSCRIPTION
  NEW_COURSE
  SPECIAL_OFFER
}

enum TargetAudience {
  ALL
  NON_PREMIUM
  SPECIFIC_COURSE_VIEWERS
  NEW_USERS
}

enum InteractionAction {
  IMPRESSION
  CLICK
  CLOSE
  CONVERSION
}

model Promotion {
  id              String           @id @default(cuid())
  type            PromotionType
  title           String
  description     String?
  ctaText         String
  ctaUrl          String
  imageUrl        String?
  isActive        Boolean          @default(true)
  startDate       DateTime?
  endDate         DateTime?
  priority        Int              @default(5)
  targetAudience  TargetAudience  @default(ALL)
  maxImpressions  Int?
  currentImpressions Int           @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  interactions    PromotionInteraction[]

  @@index([type, isActive])
  @@index([startDate, endDate])
  @@index([priority])
  @@map("promotions")
}

model PromotionInteraction {
  id           String             @id @default(cuid())
  promotionId  String
  userId       String?
  sessionId    String
  action       InteractionAction
  pageUrl      String?
  referrer     String?
  userAgent    String?
  ipAddress    String?
  createdAt    DateTime           @default(now())
  promotion    Promotion          @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  user         User?              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([promotionId, action])
  @@index([userId, createdAt])
  @@index([sessionId])
  @@map("promotion_interactions")
}

// Nuevas tablas para sistema de recomendaciones
model UserBehavior {
  id          String   @id @default(cuid())
  userId      String
  action      String   // 'view_course', 'enroll_course', 'complete_lesson', 'search', 'download_resource'
  targetId    String?  // ID del curso, lección, recurso, etc.
  targetType  String?  // 'course', 'lesson', 'resource', 'search_query'
  metadata    Json?    // Datos adicionales como tiempo de visualización, búsqueda, etc.
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, action])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("user_behaviors")
}

model UserPreference {
  id          String   @id @default(cuid())
  userId      String   @unique
  interests   String[] // Array de categorías de interés
  skillLevel  String?  // 'beginner', 'intermediate', 'advanced'
  learningGoals String[] // Array de objetivos de aprendizaje
  preferredTopics String[] // Array de temas preferidos
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Recommendation {
  id          String   @id @default(cuid())
  userId      String
  targetId    String   @map("target_id")
  targetType  String   @map("target_type")
  score       Float
  reason      String
  isViewed    Boolean  @default(false) @map("is_viewed")
  isClicked   Boolean  @default(false) @map("is_clicked")
  createdAt   DateTime @default(now()) @map("created_at")
  expiresAt   DateTime? @map("expires_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, targetType])
  @@index([score])
  @@index([expiresAt])
  @@map("recommendations")
}

model Achievement {
  id          String   @id @default(cuid())
  userId      String
  type        String
  title       String
  description String
  points      Int      @default(0)
  badge       String?
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([createdAt])
  @@map("achievements")
}
